@model DeveloperPortfolioNew.ViewModels.ContactViewModel

@{
  ViewData["Title"] = "Contact Evan";
  string error = ViewData["ErrorMessage"]?.ToString() ?? "";
}

<div class="container pt-3 pb-5">
  <div class="row pt-2 align-items-center justify-content-between">

    @* Contact Details *@
    <div class="col-lg-6 mb-4 mb-lg-0 pt-1" id="contactDetailsDiv">
      <h1 class="display-5 fw-bold mb-3 text-primary-accent">Get In Touch</h1>
      <p class="lead text-dark-gray mb-4">
        I'm always open to new opportunities and collaborations. Feel free to reach out!
      </p>

      <div class="contact-details">
        <div class="d-flex align-items-center mb-3">
          <i class="fa fa-user fs-4 me-3 text-secondary-accent"></i>
          <p class="mb-0 fs-5 text-dark-gray">
            <span class="fw-bold">Name:</span> Evan Malherbe
          </p>
        </div>

        <div class="d-flex align-items-center mb-3">
          <i class="fa-brands fa-github fs-4 me-3 text-secondary-accent"></i>
          <p class="mb-0 fs-5">
            <span class="fw-bold text-dark-gray">GitHub:</span>
            <a href="https://github.com/evanmalherbe" target="_blank" class="">https://github.com/evanmalherbe</a>
          </p>
        </div>

        <div class="d-flex align-items-center mb-3">
          <i class="fa-brands fa-linkedin fs-4 me-3 text-secondary-accent"></i>
          <p class="mb-0 fs-5">
            <span class="fw-bold text-dark-gray">LinkedIn:</span>
            <a href="http://www.linkedin.com/in/evan-malherbe" target="_blank" class="">http://www.linkedin.com/in/evan-malherbe</a>
          </p>
        </div>
      </div>
    </div>

    @* Image on right of page *@
    <div class="col-lg-4 text-center">
      <img src="https://imagestore-production.up.railway.app/images/business.jpg"
           alt="Laptop, Phone, Notebook"
           class="img-fluid med-image"
           style="max-height: 250px; object-fit: cover;">
    </div>

    @* Contact form *@
    <div id="contactFormDiv" class="p-4 mt-4 bg-light rounded shadow-sm col-12 col-lg-6 border">
      <h2 class="text-secondary-accent">Contact</h2>
      <form id="contactForm" asp-controller="Home" asp-action="Contact" method="post">
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger fw-bold mb-3 text-center" role="alert"></div>
        @if (!string.IsNullOrWhiteSpace(error))
        {
          <div class="text-danger fw-bold mb-3 text-center">@error</div>
        }

        <div class="mb-3 form-floating">
          <input asp-for="Name" type="text" class="form-control" id="name" placeholder="Your name" required />
          <label asp-for="Name">Your Name:</label>
          <span asp-validation-for="Name" class="text-danger small mt-1 d-block"></span>
        </div>

        <div class="mb-3 form-floating">
          <input asp-for="Email" type="email" class="form-control" id="email" placeholder="Your email address" required />
          <label asp-for="Email">Your Email:</label>
          <span asp-validation-for="Email" class="text-danger small mt-1 d-block"></span>
        </div>

        <div class="mb-3">
          <label for="message" class="form-label">Message:</label>
          <textarea asp-for="Message" class="form-control" id="message" rows="4" required></textarea>
        </div>

        <div class="hp-check">
          <label for="hp-field">Please ignore this field</label>
          <input type="text" id="hp-field" name="hp-field" tabindex="-1" autocomplete="off" />
        </div>
        <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response" />
        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg" id="contactButton">Send Message</button>
        </div>
      </form>
    </div>

  </div>
</div>

@section scripts {
  <partial name="_ValidationScriptsPartial" />
  <script src="https://www.google.com/recaptcha/api.js?render=6Le6eQ4sAAAAAJYoAr5PNCuNh9QQVyXnoC36dZI-"></script>
  <script type="text/javascript">
    let recaptchaHandled = false;

    $(document).ready(async function()
    {
      $("#contactForm").on("submit", function(event)
      {
        if (recaptchaHandled)
        {
          return true;
        }
        event.preventDefault();
        let $contactButton = $("#contactButton");
          // Disable button and add spinner
         $contactButton.prop("disabled", true)
         if ($("#contact-spinner").length === 0)
         {
           $contactButton.append(`<span id="contact-spinner">&nbsp;<i class="fa fa-spin fa-spinner"></i></span>`);
         }

         grecaptcha.ready(function()
         {
           grecaptcha.execute("6Le6eQ4sAAAAAJYoAr5PNCuNh9QQVyXnoC36dZI-", {action: "register"})
           .then(function(token) 
           {
             recaptchaHandled = true;
             $("#g-recaptcha-response").val(token);
             $("#contactForm").submit();
           }).catch(function(error) 
           {
             console.error("reCAPTCHA failed to execute: ", error);
             alert("Contact form submission failed due to reCAPTCHA error. Please try again.");
             $("#contactButton").prop("disabled", false);
             $("#contact-spinner").remove();
           });
         });
         // Re-enable button
        $("#contactButton").prop("disabled", false);
        $("#contact-spinner").remove();
      });
    });
  </script>
}
